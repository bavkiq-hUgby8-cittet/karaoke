<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Diagn√≥stico Karaok√™</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: white;
            padding: 20px;
            min-height: 100vh;
        }
        h1 { margin-bottom: 20px; }
        .test {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .test h3 {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        .status.loading { background: #f39c12; }
        .status.ok { background: #27ae60; }
        .status.error { background: #e74c3c; }
        .log {
            background: #0f0f23;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85em;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .log div { margin: 5px 0; }
        .log .error { color: #e74c3c; }
        .log .success { color: #27ae60; }
        .log .info { color: #3498db; }
        button {
            padding: 15px 30px;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        #youtubeTest {
            width: 100%;
            height: 200px;
            background: #000;
            border-radius: 8px;
            margin-top: 10px;
        }
        #qrTest {
            background: white;
            padding: 10px;
            border-radius: 8px;
            display: inline-block;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>üîß Diagn√≥stico do Karaok√™</h1>
    
    <!-- Teste 1: Firebase -->
    <div class="test">
        <h3>1Ô∏è‚É£ Firebase <span class="status loading" id="firebaseStatus">Testando...</span></h3>
        <p>Conex√£o com o banco de dados</p>
        <div class="log" id="firebaseLog"></div>
        <button class="btn-primary" onclick="testFirebaseWrite()">Testar Escrita</button>
        <button class="btn-primary" onclick="testFirebaseRead()">Testar Leitura</button>
    </div>
    
    <!-- Teste 2: QR Code -->
    <div class="test">
        <h3>2Ô∏è‚É£ QR Code <span class="status loading" id="qrStatus">Testando...</span></h3>
        <p>Biblioteca de gera√ß√£o de QR Code</p>
        <div id="qrTest"></div>
        <div class="log" id="qrLog"></div>
    </div>
    
    <!-- Teste 3: YouTube -->
    <div class="test">
        <h3>3Ô∏è‚É£ YouTube <span class="status loading" id="ytStatus">Testando...</span></h3>
        <p>API do YouTube para reproduzir v√≠deos</p>
        <div id="youtubeTest"></div>
        <div class="log" id="ytLog"></div>
        <button class="btn-success" onclick="testYouTubePlay()">Testar Play</button>
    </div>
    
    <!-- Teste 4: Microfone -->
    <div class="test">
        <h3>4Ô∏è‚É£ Microfone <span class="status loading" id="micStatus">Aguardando...</span></h3>
        <p>Acesso ao microfone do dispositivo</p>
        <div class="log" id="micLog"></div>
        <button class="btn-warning" onclick="testMicrophone()">Testar Microfone</button>
    </div>
    
    <!-- Resumo -->
    <div class="test" style="background: #2c3e50;">
        <h3>üìã Resumo</h3>
        <div id="summary" style="margin-top: 10px;"></div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <script>
        // Resultados dos testes
        const results = {
            firebase: null,
            qr: null,
            youtube: null,
            mic: null
        };
        
        // ========== FIREBASE ==========
        const firebaseLog = document.getElementById('firebaseLog');
        let db, gameRef;
        
        function logFirebase(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            firebaseLog.appendChild(div);
            firebaseLog.scrollTop = firebaseLog.scrollHeight;
            console.log('Firebase:', msg);
        }
        
        function initFirebase() {
            try {
                logFirebase('Inicializando Firebase...');
                
                const config = {
                    apiKey: "AIzaSyBkmz4IlYeqip-u_0MCO4Hlb--MsZtTspw",
                    authDomain: "karaoke-46db0.firebaseapp.com",
                    databaseURL: "https://karaoke-46db0-default-rtdb.firebaseio.com",
                    projectId: "karaoke-46db0"
                };
                
                firebase.initializeApp(config);
                db = firebase.database();
                gameRef = db.ref('karaoke');
                
                logFirebase('Firebase inicializado!', 'success');
                
                // Testa conex√£o
                db.ref('.info/connected').on('value', (snap) => {
                    if (snap.val() === true) {
                        logFirebase('Conectado ao Firebase!', 'success');
                        document.getElementById('firebaseStatus').textContent = 'Conectado';
                        document.getElementById('firebaseStatus').className = 'status ok';
                        results.firebase = true;
                        updateSummary();
                    } else {
                        logFirebase('Desconectado do Firebase', 'error');
                        document.getElementById('firebaseStatus').textContent = 'Desconectado';
                        document.getElementById('firebaseStatus').className = 'status error';
                    }
                });
                
            } catch (error) {
                logFirebase('ERRO: ' + error.message, 'error');
                document.getElementById('firebaseStatus').textContent = 'Erro';
                document.getElementById('firebaseStatus').className = 'status error';
                results.firebase = false;
                updateSummary();
            }
        }
        
        function testFirebaseWrite() {
            if (!gameRef) {
                logFirebase('Firebase n√£o inicializado!', 'error');
                return;
            }
            
            logFirebase('Tentando escrever no banco...');
            
            gameRef.child('teste').set({
                timestamp: Date.now(),
                message: 'Teste de escrita'
            }).then(() => {
                logFirebase('‚úÖ Escrita OK!', 'success');
            }).catch((error) => {
                logFirebase('‚ùå Erro na escrita: ' + error.message, 'error');
                logFirebase('‚ö†Ô∏è Verifique as REGRAS do Firebase!', 'error');
            });
        }
        
        function testFirebaseRead() {
            if (!gameRef) {
                logFirebase('Firebase n√£o inicializado!', 'error');
                return;
            }
            
            logFirebase('Tentando ler do banco...');
            
            gameRef.child('teste').once('value')
                .then((snap) => {
                    logFirebase('‚úÖ Leitura OK! Dados: ' + JSON.stringify(snap.val()), 'success');
                })
                .catch((error) => {
                    logFirebase('‚ùå Erro na leitura: ' + error.message, 'error');
                    logFirebase('‚ö†Ô∏è Verifique as REGRAS do Firebase!', 'error');
                });
        }
        
        // ========== QR CODE ==========
        const qrLog = document.getElementById('qrLog');
        
        function logQR(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = msg;
            qrLog.appendChild(div);
            console.log('QR:', msg);
        }
        
        function initQR() {
            try {
                logQR('Gerando QR Code...');
                
                const url = 'https://bavkiq-hugby8-cittet.github.io/karaoke/jogador.html';
                
                QRCode.toCanvas(document.getElementById('qrTest'), url, {
                    width: 150,
                    margin: 1
                }, function(error) {
                    if (error) {
                        logQR('‚ùå Erro: ' + error, 'error');
                        document.getElementById('qrStatus').textContent = 'Erro';
                        document.getElementById('qrStatus').className = 'status error';
                        results.qr = false;
                    } else {
                        logQR('‚úÖ QR Code gerado!', 'success');
                        logQR('URL: ' + url, 'info');
                        document.getElementById('qrStatus').textContent = 'OK';
                        document.getElementById('qrStatus').className = 'status ok';
                        results.qr = true;
                    }
                    updateSummary();
                });
            } catch (error) {
                logQR('‚ùå Biblioteca n√£o carregou: ' + error.message, 'error');
                document.getElementById('qrStatus').textContent = 'Erro';
                document.getElementById('qrStatus').className = 'status error';
                results.qr = false;
                updateSummary();
            }
        }
        
        // ========== YOUTUBE ==========
        const ytLog = document.getElementById('ytLog');
        let ytPlayer = null;
        
        function logYT(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = msg;
            ytLog.appendChild(div);
            console.log('YouTube:', msg);
        }
        
        function initYouTube() {
            logYT('Carregando API do YouTube...');
            
            const tag = document.createElement('script');
            tag.src = 'https://www.youtube.com/iframe_api';
            tag.onerror = function() {
                logYT('‚ùå Falha ao carregar API', 'error');
                document.getElementById('ytStatus').textContent = 'Erro';
                document.getElementById('ytStatus').className = 'status error';
                results.youtube = false;
                updateSummary();
            };
            document.head.appendChild(tag);
        }
        
        // Callback global do YouTube
        window.onYouTubeIframeAPIReady = function() {
            logYT('‚úÖ API do YouTube carregada!', 'success');
            
            try {
                ytPlayer = new YT.Player('youtubeTest', {
                    height: '200',
                    width: '100%',
                    videoId: 'dQw4w9WgXcQ', // Video de teste
                    playerVars: {
                        autoplay: 0,
                        controls: 1
                    },
                    events: {
                        onReady: function(event) {
                            logYT('‚úÖ Player pronto!', 'success');
                            document.getElementById('ytStatus').textContent = 'OK';
                            document.getElementById('ytStatus').className = 'status ok';
                            results.youtube = true;
                            updateSummary();
                        },
                        onError: function(event) {
                            logYT('‚ùå Erro no player: ' + event.data, 'error');
                            document.getElementById('ytStatus').textContent = 'Erro';
                            document.getElementById('ytStatus').className = 'status error';
                            results.youtube = false;
                            updateSummary();
                        }
                    }
                });
            } catch (error) {
                logYT('‚ùå Erro ao criar player: ' + error.message, 'error');
                document.getElementById('ytStatus').textContent = 'Erro';
                document.getElementById('ytStatus').className = 'status error';
                results.youtube = false;
                updateSummary();
            }
        };
        
        function testYouTubePlay() {
            if (ytPlayer && ytPlayer.playVideo) {
                ytPlayer.playVideo();
                logYT('‚ñ∂Ô∏è Play!', 'success');
            } else {
                logYT('Player n√£o est√° pronto', 'error');
            }
        }
        
        // ========== MICROFONE ==========
        const micLog = document.getElementById('micLog');
        
        function logMic(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = msg;
            micLog.appendChild(div);
            console.log('Mic:', msg);
        }
        
        async function testMicrophone() {
            logMic('Solicitando acesso ao microfone...');
            document.getElementById('micStatus').textContent = 'Testando...';
            document.getElementById('micStatus').className = 'status loading';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                logMic('‚úÖ Microfone acessado!', 'success');
                
                // Testa √°udio
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                
                logMic('‚úÖ An√°lise de √°udio funcionando!', 'success');
                
                // Para o stream
                stream.getTracks().forEach(t => t.stop());
                audioContext.close();
                
                document.getElementById('micStatus').textContent = 'OK';
                document.getElementById('micStatus').className = 'status ok';
                results.mic = true;
                
            } catch (error) {
                logMic('‚ùå Erro: ' + error.message, 'error');
                document.getElementById('micStatus').textContent = 'Erro';
                document.getElementById('micStatus').className = 'status error';
                results.mic = false;
            }
            
            updateSummary();
        }
        
        // ========== RESUMO ==========
        function updateSummary() {
            const summary = document.getElementById('summary');
            
            let html = '<ul style="list-style: none;">';
            
            html += `<li>${results.firebase === true ? '‚úÖ' : results.firebase === false ? '‚ùå' : '‚è≥'} Firebase: ${
                results.firebase === true ? 'Funcionando' : 
                results.firebase === false ? 'PROBLEMA - Verifique as regras!' : 
                'Testando...'
            }</li>`;
            
            html += `<li>${results.qr === true ? '‚úÖ' : results.qr === false ? '‚ùå' : '‚è≥'} QR Code: ${
                results.qr === true ? 'Funcionando' : 
                results.qr === false ? 'PROBLEMA' : 
                'Testando...'
            }</li>`;
            
            html += `<li>${results.youtube === true ? '‚úÖ' : results.youtube === false ? '‚ùå' : '‚è≥'} YouTube: ${
                results.youtube === true ? 'Funcionando' : 
                results.youtube === false ? 'PROBLEMA' : 
                'Testando...'
            }</li>`;
            
            html += `<li>${results.mic === true ? '‚úÖ' : results.mic === false ? '‚ùå' : '‚è≥'} Microfone: ${
                results.mic === true ? 'Funcionando' : 
                results.mic === false ? 'PROBLEMA' : 
                'Clique em "Testar Microfone"'
            }</li>`;
            
            html += '</ul>';
            
            // Diagn√≥stico
            if (results.firebase === false) {
                html += `<div style="margin-top: 15px; padding: 15px; background: #e74c3c; border-radius: 8px;">
                    <strong>‚ö†Ô∏è PROBLEMA COM FIREBASE!</strong><br><br>
                    Acesse: <a href="https://console.firebase.google.com/project/karaoke-46db0/database/karaoke-46db0-default-rtdb/rules" target="_blank" style="color: white;">Regras do Firebase</a><br><br>
                    E configure:<br>
                    <code style="background: #000; padding: 10px; display: block; margin-top: 10px; border-radius: 5px;">
{<br>
&nbsp;&nbsp;"rules": {<br>
&nbsp;&nbsp;&nbsp;&nbsp;".read": true,<br>
&nbsp;&nbsp;&nbsp;&nbsp;".write": true<br>
&nbsp;&nbsp;}<br>
}
                    </code>
                </div>`;
            }
            
            summary.innerHTML = html;
        }
        
        // ========== INICIALIZA√á√ÉO ==========
        document.addEventListener('DOMContentLoaded', function() {
            initFirebase();
            initQR();
            initYouTube();
            updateSummary();
        });
    </script>
</body>
</html>
